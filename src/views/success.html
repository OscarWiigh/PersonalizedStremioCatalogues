<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Success - Trakt Stremio Addon</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
    }
    
    .success-icon {
      text-align: center;
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .addon-url-box {
      background: #f8f9fa;
      border: 2px solid #667eea;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 25px;
    }
    
    .addon-url-box h3 {
      color: #333;
      font-size: 16px;
      margin-bottom: 12px;
    }
    
    .url-display {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #667eea;
      word-break: break-all;
      margin-bottom: 12px;
    }
    
    .copy-button {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .copy-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .copy-button:active {
      transform: translateY(0);
    }
    
    .copy-button.copied {
      background: #28a745;
    }
    
    .instructions {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 25px;
    }
    
    .instructions h3 {
      color: #333;
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .instructions ol {
      padding-left: 20px;
      color: #555;
      font-size: 14px;
      line-height: 1.8;
    }
    
    .instructions li {
      margin-bottom: 8px;
    }
    
    .features {
      background: #e7f3ff;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .features h3 {
      color: #333;
      font-size: 16px;
      margin-bottom: 12px;
    }
    
    .features ul {
      list-style: none;
      padding: 0;
    }
    
    .features li {
      color: #555;
      font-size: 14px;
      margin-bottom: 8px;
      padding-left: 24px;
      position: relative;
    }
    
    .features li:before {
      content: "‚úì";
      position: absolute;
      left: 0;
      color: #28a745;
      font-weight: bold;
    }
    
    .back-link {
      text-align: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }
    
    .back-link a {
      color: #667eea;
      text-decoration: none;
      font-size: 14px;
    }
    
    .back-link a:hover {
      text-decoration: underline;
    }
    
    /* Netflix Import Styles */
    .import-section {
      background: #fff8e1;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 20px;
      margin: 25px 0;
    }
    
    .import-section h3 {
      color: #333;
      font-size: 18px;
      margin-bottom: 10px;
    }
    
    .import-section p {
      color: #666;
      font-size: 14px;
      margin-bottom: 15px;
    }
    
    .file-input-wrapper {
      position: relative;
      margin-bottom: 15px;
    }
    
    .file-input-wrapper input[type="file"] {
      display: none;
    }
    
    .file-label {
      display: inline-block;
      padding: 10px 20px;
      background: #f0f0f0;
      border: 2px dashed #ccc;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      width: 100%;
    }
    
    .file-label:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }
    
    .file-label.has-file {
      border-color: #28a745;
      background: #d4edda;
      border-style: solid;
    }
    
    .import-button {
      width: 100%;
      background: #ffc107;
      color: #333;
      border: none;
      padding: 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .import-button:hover:not(:disabled) {
      background: #ffb300;
      transform: translateY(-1px);
    }
    
    .import-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .progress-bar {
      display: none;
      background: #f0f0f0;
      border-radius: 10px;
      height: 20px;
      margin: 15px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }
    
    .progress-status {
      display: none;
      text-align: center;
      color: #666;
      font-size: 13px;
      margin-top: 10px;
      min-height: 40px;
      line-height: 1.4;
    }
    
    .import-results {
      display: none;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 6px;
      padding: 15px;
      margin-top: 15px;
    }
    
    .import-results.error {
      background: #f8d7da;
      border-color: #f5c6cb;
    }
    
    .import-results h4 {
      color: #155724;
      margin-bottom: 10px;
      font-size: 16px;
    }
    
    .import-results.error h4 {
      color: #721c24;
    }
    
    .import-results ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .import-results li {
      color: #155724;
      font-size: 14px;
      padding: 5px 0;
    }
    
    .import-results.error li {
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="success-icon">‚úÖ</div>
    <h1>Authentication Successful!</h1>
    <p class="subtitle">Your addon is ready to use</p>
    
    <div class="addon-url-box">
      <h3>Step 1: Install the Addon</h3>
      <p style="color: #666; font-size: 14px; margin-bottom: 12px;">
        Click to install in Stremio (works for both Web and Desktop):
      </p>
      
      <div class="url-display" id="addon-url">stremio://127.0.0.1:8000/manifest.json</div>
      <button class="copy-button" onclick="installInStremio()" style="margin-bottom: 10px;">
        üì• Install in Stremio
      </button>
      <button class="copy-button" onclick="copyUrl()" style="background: #6c757d;">
        üìã Copy URL
      </button>
    </div>
    
    <div class="addon-url-box" style="background: #fff3cd; border-left: 4px solid #ffc107;">
      <h3>Step 2: Paste Your Session ID</h3>
      <p style="color: #856404; font-size: 14px; margin-bottom: 12px;">
        <strong>‚ö†Ô∏è Important:</strong> After installing, Stremio will show a configuration screen. Copy and paste this Session ID:
      </p>
      
      <div class="url-display" id="session-id" style="font-family: 'Courier New', monospace; font-size: 13px; background: #fff; word-break: break-all;">SESSION_ID_HERE</div>
      <button class="copy-button" onclick="copySessionId()" style="background: #28a745;">
        üìã Copy Session ID
      </button>
    </div>
    
    <div class="instructions">
      <h3>Complete Setup Guide:</h3>
      <ol>
        <li><strong>Click "Install in Stremio"</strong> button above</li>
        <li>Stremio will open and show a <strong>configuration screen</strong></li>
        <li><strong>Paste your Session ID</strong> from the yellow box into the "Session ID" field in Stremio</li>
        <li>Click <strong>"Install"</strong> in Stremio</li>
        <li>‚úÖ Done! Your personal Trakt recommendations will now appear</li>
      </ol>
      
      <p style="color: #666; font-size: 13px; margin-top: 15px;">
        üí° <strong>Tip:</strong> Keep your Session ID private - it links this addon to your Trakt account!
      </p>
    </div>
    
    <div class="features">
      <h3>What You Get:</h3>
      <ul>
        <li>Personal Trakt recommendations based on your watch history</li>
        <li>Netflix Sweden Top 10 movies</li>
        <li>New & Popular content from TMDB</li>
        <li>Automatic watch syncing to Trakt when you watch in Stremio</li>
      </ul>
    </div>
    
    <div class="import-section">
      <h3>üì• Import Netflix Watch History</h3>
      <p>Already have Netflix viewing history? Import it to get personalized Trakt recommendations instantly!</p>
      
      <div class="file-input-wrapper">
        <input type="file" id="netflix-csv" accept=".csv" onchange="handleFileSelect(event)">
        <label for="netflix-csv" class="file-label" id="file-label">
          üìÑ Choose Netflix CSV File
        </label>
      </div>
      
      <button class="import-button" id="import-button" onclick="startImport()" disabled>
        Import to Trakt
      </button>
      
      <div class="progress-bar" id="progress-bar">
        <div class="progress-fill" id="progress-fill">0%</div>
      </div>
      
      <div class="progress-status" id="progress-status"></div>
      
      <div class="import-results" id="import-results"></div>
      
      <p style="font-size: 12px; color: #999; margin-top: 15px;">
        üí° Get your Netflix history: Netflix ‚Üí Account ‚Üí Viewing Activity ‚Üí Download All
      </p>
    </div>
    
    <div class="back-link">
      <a href="/">‚Üê Back to Setup</a>
    </div>
  </div>
  
  <script>
    let selectedFile = null;
    
    function installInStremio() {
      const urlElement = document.getElementById('addon-url');
      const addonUrl = urlElement.textContent;
      
      // Open in Stremio using the stremio:// protocol
      window.location.href = addonUrl;
      
      // Show feedback
      const buttons = document.querySelectorAll('.copy-button');
      buttons[0].textContent = 'Opening Stremio...';
      buttons[0].classList.add('copied');
      
      setTimeout(() => {
        buttons[0].textContent = 'Install in Stremio';
        buttons[0].classList.remove('copied');
      }, 3000);
    }
    
    function copyUrl() {
      const urlElement = document.getElementById('addon-url');
      const buttons = document.querySelectorAll('.copy-button');
      
      // Create temporary textarea to copy from
      const textarea = document.createElement('textarea');
      textarea.value = urlElement.textContent;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      
      // Update button
      buttons[1].textContent = '‚úì Copied!';
      buttons[1].classList.add('copied');
      
      setTimeout(() => {
        buttons[1].textContent = 'üìã Copy URL';
        buttons[1].classList.remove('copied');
      }, 2000);
    }
    
    function copySessionId() {
      const sessionElement = document.getElementById('session-id');
      const button = event.target;
      
      // Create temporary textarea to copy from
      const textarea = document.createElement('textarea');
      textarea.value = sessionElement.textContent;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      
      // Update button
      button.textContent = '‚úì Copied!';
      button.classList.add('copied');
      
      setTimeout(() => {
        button.textContent = 'üìã Copy Session ID';
        button.classList.remove('copied');
      }, 2000);
    }
    
    // Netflix CSV Import Functions
    function handleFileSelect(event) {
      const file = event.target.files[0];
      const label = document.getElementById('file-label');
      const button = document.getElementById('import-button');
      
      if (file) {
        if (!file.name.endsWith('.csv')) {
          alert('Please select a CSV file');
          return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
          alert('File too large. Maximum size is 5MB');
          return;
        }
        
        selectedFile = file;
        label.textContent = `‚úì ${file.name}`;
        label.classList.add('has-file');
        button.disabled = false;
      } else {
        selectedFile = null;
        label.textContent = 'üìÑ Choose Netflix CSV File';
        label.classList.remove('has-file');
        button.disabled = true;
      }
    }
    
    async function startImport() {
      if (!selectedFile) {
        alert('Please select a file first');
        return;
      }
      
      const button = document.getElementById('import-button');
      const progressBar = document.getElementById('progress-bar');
      const progressFill = document.getElementById('progress-fill');
      const progressStatus = document.getElementById('progress-status');
      const resultsDiv = document.getElementById('import-results');
      
      // Reset UI
      button.disabled = true;
      progressBar.style.display = 'block';
      progressStatus.style.display = 'block';
      resultsDiv.style.display = 'none';
      resultsDiv.className = 'import-results';
      
      // Generate unique session ID
      const sessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      
      // Set up SSE connection for real-time progress
      const eventSource = new EventSource(`/api/import-netflix/progress/${sessionId}`);
      
      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          
          if (data.type === 'parsing') {
            progressStatus.textContent = data.message;
            progressFill.style.width = data.progress + '%';
            progressFill.textContent = data.progress + '%';
          } else if (data.type === 'parsed') {
            progressStatus.textContent = data.message;
            progressFill.style.width = data.progress + '%';
            progressFill.textContent = data.progress + '%';
          } else if (data.type === 'matching') {
            progressStatus.textContent = `${data.message} - ${data.title || ''}`;
            progressFill.style.width = data.progress + '%';
            progressFill.textContent = data.progress + '%';
          } else if (data.type === 'matched') {
            progressStatus.textContent = data.message;
            progressFill.style.width = data.progress + '%';
            progressFill.textContent = data.progress + '%';
          } else if (data.type === 'syncing_start') {
            progressStatus.textContent = data.message;
            progressFill.style.width = data.progress + '%';
            progressFill.textContent = data.progress + '%';
          } else if (data.type === 'syncing') {
            progressStatus.textContent = data.message;
            progressFill.style.width = data.progress + '%';
            progressFill.textContent = data.progress + '%';
          } else if (data.type === 'complete') {
            progressFill.style.width = '100%';
            progressFill.textContent = '100%';
            progressStatus.textContent = data.message;
          } else if (data.type === 'error') {
            progressStatus.textContent = 'Error: ' + data.message;
          }
        } catch (err) {
          console.error('Error parsing SSE data:', err);
        }
      };
      
      eventSource.onerror = () => {
        eventSource.close();
      };
      
      try {
        // Read CSV file
        progressStatus.textContent = 'Reading CSV file...';
        progressFill.style.width = '2%';
        progressFill.textContent = '2%';
        
        const csvText = await selectedFile.text();
        
        // Send to server with session ID
        const response = await fetch('/api/import-netflix', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            csvData: csvText,
            sessionId: sessionId
          })
        });
        
        const result = await response.json();
        
        // Close SSE connection
        eventSource.close();
        
        // Show results
        setTimeout(() => {
          progressBar.style.display = 'none';
          progressStatus.style.display = 'none';
          
          resultsDiv.style.display = 'block';
          
          if (result.success) {
            resultsDiv.innerHTML = `
              <h4>‚úÖ Import Complete!</h4>
              <ul>
                <li><strong>${result.matched}</strong> titles matched</li>
                <li><strong>${result.synced}</strong> synced to Trakt</li>
                <li><strong>${result.skipped}</strong> skipped (couldn't match)</li>
                ${result.failed ? `<li><strong>${result.failed}</strong> failed to sync</li>` : ''}
              </ul>
            `;
          } else {
            resultsDiv.classList.add('error');
            resultsDiv.innerHTML = `
              <h4>‚ùå Import Failed</h4>
              <ul>
                <li>${result.error || 'Unknown error occurred'}</li>
                ${result.matched ? `<li>${result.matched} titles were matched</li>` : ''}
              </ul>
            `;
          }
          
          button.disabled = false;
        }, 500);
        
      } catch (error) {
        eventSource.close();
        progressBar.style.display = 'none';
        progressStatus.style.display = 'none';
        
        resultsDiv.style.display = 'block';
        resultsDiv.classList.add('error');
        resultsDiv.innerHTML = `
          <h4>‚ùå Error</h4>
          <ul>
            <li>${error.message}</li>
          </ul>
        `;
        
        button.disabled = false;
      }
    }
  </script>
</body>
</html>

